<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>CharIoTeer, Smart Last-Mile Delivery Project @MakeZurich</title>
    <meta name="description" content="Personal Blog">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/academicons.css"/>
    <link href="/css/lightbox.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/zenburn.css"/>

	<link type="application/atom+xml" rel="alternate" href="http://www.martinholub.com//feed.xml" title="martin-holub.github.io" />
</head>


  <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <nav class="site-nav">

      <div class="trigger">
        <!-- martin-holub.github.io instead of blog -->
        <a class="page-link" href="/">about</a>

        <!-- ( for page in site.pages )  was previously-->
        
          
          <a class="page-link" href="/blog">blog</a>
          
        
          
          <a class="page-link" href="/portfolio">projects</a>
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">CharIoTeer, Smart Last-Mile Delivery Project @MakeZurich</h1>
    <p class="post-meta">August 5, 2018 — 16:02 • <a href="https://martinholub.github.io/eth/code/2018/08/05/MakeZurich.html#disqus_thread">0 Comments</a></p>
  </header>
  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: false,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    messageStyle: "normal",
    "HTML-CSS": {
      preferredFont: null
    },
    TeX: {
      extensions: ["AMSmath.js", "AMSsymbols.js","AMScd.js", "autobold.js", "begingroup.js", "mhchem.js"]
    }
  });
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
>
</script>


  <article class="post-content">
    <!-- Need image here! -->
<div class="img_row" style="width: 100%;">
  <img class="col three" src="/img/mkzh/network.png" alt="" title="LoRaWAN" />
</div>
<div class="col three caption">
The overview picture of operation of LoRaWAN network ([source](https://www.thethingsnetwork.org))
</div>

<p>In this post, I will tell you about an exciting <a href="https://en.wikipedia.org/wiki/Internet_of_things">IoT</a> device me and my team prototyped at <a href="https://makezurich.ch/">MakeZurich week-long makerdays</a>. Keep reading if you are a maker, IoT enthusiast or a person interested in using IoT principles in a real world scenario.</p>

<h2 id="makezurich">MakeZurich</h2>

<p>MakeZurich is the “Civic Tech and LoRaWAN Hackdays for a better city”. It is organized jointly with the city administration to explore new ways of solving challenges the city is facing with the help of open networks and civic tech. I missed the first run, that took place last year, because I found out about the event too late. This year, I had it in my calendar and was ready to take part. The event had a smell of a hackathon: difficult and open-ended challenges to be tackled in innovative fashion in too little time in small teams, mostly with people you didn’t know before the kickoff. But it was more than that. Rather than hackathon,it were Makerdays or Hackdays. It lasted for full 8 days, and on each day a makerspace was open so that I could just drop by, ask people about technical issues I was having and hack on the prototype and code for our project. In retrospect, I view the event as great learning experience that gave me quick insight into the field of IoT and LoRaWAN. (Big thanks to the organizers for all their work, it showed!)</p>

<h2 id="lorawan">LoRaWAN</h2>

<p>LoRa what? Myself, I didn’t know anything about the <a href="https://www.thethingsnetwork.org/docs/lorawan/">Long Range Wide Area Network</a> until about one week before the event, but I came to understand that it is a very interesting player in the landscape of wireless communication technologies. It is designed to allow low-powered devices to communicate with Internet-connected applications over long range wirelessly. It is well suited for applications with very low bandwidth, something up to 400 bytes/hour, where individual message should not exceed 12 bytes.</p>

<p>The following picture will give you an idea how a device (node) communicates with internet application via LoRaWAN:</p>

<div class="img_row" style="width: 100%;">
  <img class="col three" src="/img/mkzh/lorawan.png" alt="" title="LoRaWAN" />
</div>
<div class="col three caption">
The overview picture of operation of device using LoRaWAN
</div>

<p>As you see, the communication is handed over to an internet protocol once the message was received by a gateway. LoRa, being long range technology, enables each device to emit messages to the distance of about 20+km in rural and about 2-5km in urban settings. Whether a message is successfully received and passed to an application depends on whether there is a gateway present in that range that is ready to receive.</p>

<p>All this is nice but it becomes practically very powerful thanks to <a href="https://www.thethingsnetwork.org/"><em>The Things Network</em> (TTN)</a> initiative that implements an <a href="https://account.thethingsnetwork.org/users/login">open source backend</a> that handles messaging between nodes and applications and that is available for anyone to use. Even more interestingly, the gateways, intermediary infrastructure for The Things Network, are mostly deployed by the users themselves. This is possible because they are cheap (~250 Eur), small, simple, and can serve many nodes in large area.</p>

<p>If this sounds too good to be true, check the map of coverage of Zurich below. What this means, is that I can drop my LoRa capable sensor node anywhere in the large area of Zurich and have it send me measurements to my application without having to even think about the infrastructure. Cool isn’t it? (It is possible thanks to the <a href="https://www.thethingsnetwork.org/community/zurich/">ZH TTN community</a> which is very active. Hat tip to them!)</p>

<div class="img_row" style="width: 80%;">
  <img class="col three" src="/img/mkzh/zhcoverage.png" alt="" title="Zurich Coverage" />
</div>
<div class="col three caption">
The Things Network LoRaWAN coverage in Zurich
</div>

<p>The devices and gateways operate in unlicensed spectrum of 868Mhz (Europe), meaning that anyone who wants to can deploy his own LoRaWAN network. The Things Network currently supports <em>Class A</em> device type, which means that each device can send a message to gateway at any time, but it can receive a response only at predefined intervals after sending.</p>

<p>Some of the <a href="https://www.thethingsnetwork.org/docs/lorawan/limitations.html">limitations</a> of a LoRaWAN network include the restricted payload size and narrow bandwidth. Additionally, the TTN mandates fair usage policy with 30 seconds of airtime per day (this translates to about 20-500 messages per day, depending on message’s payload and bandwidth) and only 10 messages to the device from application per day (aka downlink messages).</p>

<p>If you want to dig deeper into how LoRaWAN and The Things Network work, visit the highly readable <a href="https://www.thethingsnetwork.org/docs/">documentation of TTN</a>.</p>

<h2 id="the-challenge">The Challenge</h2>

<p>The MakeZurich Makerdays revolved around 7 challenges that were crafted with the participation of the city administration (you can see all of them <a href="https://speakerdeck.com/gonzalocasas/make-zurich-vol-ii-kick-off">here</a>). These are real-world challenges that the city is facing and that it is seeking solutions for. Our team, made up of an internet entrepreneur, project manager, data scientist and me, chose to work on a challenge termed “Conquering The Last Mile”. We were working closely with a Swiss company providing logistic services, mainly last-mile bicycle package delivery, in many cities in Switzerland.</p>

<div class="img_row" style="width: 70%;">
  <img class="col three" src="/img/mkzh/meonbike.jpg" alt="" title="Me On Bike" />
</div>
<div class="col three caption">
Me doing a test drive on a last-mile delivery cargo bike.  
</div>

<p>During MakeZurich, we focused on particular problem of deliveries of packages containing sensitive biological material, for example between pharmacies and hospitals. In such scenario, it is crucial to monitor, among others, the temperature of the package contents to be able to prove that the material has stayed in required temperature range throughout the time of the delivery. Further, one can think of scenario when the deliveries are rescheduled on the fly depending on location of other drivers, their availability and the predicted time when the sensitive delivery will go stale.</p>

<p>Solutions to temperature monitoring of sensitive mobile packages exist, but they require the personnel of the pharmacy to always put a single-use device in the package before it is sealed. This is time consuming, error prone and unnecessarily costly.</p>

<h2 id="the-prototype">The Prototype</h2>

<p>Each group received a “challenge box” with some hardware that was potentially useful for work on the challenge. In the week we had to work on a prototype, I hacked together an Arduino based device that simultaneously measures temperature inside and outside of the package, humidity, package orientation and its geographical location, mostly using this hardware. I especially enjoyed writing C++ code for data collection, processing and messaging on the microcontroller and I had great fun brushing up my soldering and 3D printing skills.</p>

<div class="img_row">
	<img class="col two" src="/img/mkzh/hw2.jpg" />
	<img class="col one" src="/img/mkzh/hw1.jpg" />
</div>
<div class="col three caption">
The prototype of a device that makes last-mile delivery smart
</div>

<h3 id="talking-with-the-things-network">Talking with The Things Network</h3>

<p>Previously, I wrote about the limitations on payload size imposed by the LoRa or TTN.  In practice, this means, one has to think a bit about what information needs to be transmitted and how often. Sending data as plain text or <code class="language-html highlighter-rouge">JSON</code> is a no-go, therefore I encoded the messages as bytes. The message is then decoded in the online application using reverse of operations that were used for encoding. Let’s look at an example for the GPS data:</p>

<h4 id="encoder">Encoder</h4>

<script src="https://gist.github.com/e42e59461f7847fc9e5eac06caeac098.js?file=add_buffer_gps.cpp"> </script>

<h4 id="decoder">Decoder</h4>

<script src="https://gist.github.com/e42e59461f7847fc9e5eac06caeac098.js?file=decode_gps.js"> </script>

<h4 id="sending-the-payload">Sending the Payload</h4>

<p>Once we have a way to to encode and interpret the data, we can start sending some measurements. Thanks to the <code class="language-html highlighter-rouge">TheThingsNetwork</code> library, this is fairly simple. Here is a bare-bones example:</p>

<script src="https://gist.github.com/e42e59461f7847fc9e5eac06caeac098.js?file=ttn_example.cpp"> </script>

<h4 id="received-data">Received Data</h4>

<p>As a result, our application will receive a message from the device (node) enriched by metadata provided by the gateway(s) that picked up the message. Below is an example of a datapoint:</p>

<script src="https://gist.github.com/e42e59461f7847fc9e5eac06caeac098.js?file=datapoint.json"> </script>

<h3 id="visualizing-the-data">Visualizing the Data</h3>

<p>Once the data was received by the application, it can be fed into visualizations, machine learning application or stored in a database. Here is a <a href="https://ttn-milesahead.herokuapp.com/">website</a> (set up by <a href="https://github.com/njam">@njam</a>) that visualizes the measurement points on a map, color-coded by the temperature as measured by the in-package sensor.</p>

<div class="img_row" style="width: 80%;">
  <a href="https://ttn-milesahead.herokuapp.com/"><img class="col three" src="/img/mkzh/vis.png" alt="" title="Visualization App" /></a>
</div>
<div class="col three caption">
Visualization of temperature data together with their GPS location
</div>

<h3 id="printing-the-case">Printing the Case</h3>

<p>I wanted to have a nice casing for the project to work as tight protective enclosure and to make it all together look neat. To design the case (starting from a <a href="https://www.thingiverse.com/thing:78032">template</a>) I used <a href="http://www.openscad.org/">OpenSCAD</a>. I sliced the <code class="language-html highlighter-rouge">stl</code> files to <code class="language-html highlighter-rouge">gcode</code> using <a href="https://ultimaker.com/en/products/ultimaker-cura-software">CURA</a> and printed them on a 3D printer from <a href="https://www.teil3.ch/shop/3d-drucker.html">Teil3</a> (it worked perfectly, respect to them).</p>

<div class="img_row" style="width: 80%;">
  <img class="col three" src="/img/mkzh/hw_scad.png" alt="" title="HW in SCAD" />
</div>
<div class="col three caption">
Design of the simple casing
</div>

<h3 id="test-drive">Test Drive</h3>

<p>Once the prototype was ready, we did some test rides with temperature critical items and collected real world data.</p>

<div class="img_row">
	<img class="col two" src="/img/mkzh/beer_box.png" alt="" title="Me On Bike" />
	<img class="col one" src="/img/mkzh/driver.jpg" alt="" title="Driver" />
</div>
<div class="col three caption">
Collecting data in the wide open
</div>

<h2 id="conclusion">Conclusion</h2>

<p>During MakeZurich our team prototyped a microcontroller based device that can make last-mile delivery smarter. We call it CharIoTeer. In just one week, we came up with fully functioning prototype that is portable and communicates its measurements over LoRa and The Things Network. For me, the project was great opportunity to work hard, have fun and quickly pick up practical skills in LoRaWAN and electronics prototyping, mainly by interacting with other people and asking lot of questions. I am excited about digging deeper into the domain of IoT, with focus on Industrial IoT and machine to machine communication. What about implementing IoT paradigm in a biology lab to achieve unparalleled throughput, big data harvesting, end-to-end process control and automate decision making? Sounds both feasible and fun to me:)</p>

<hr />
<h2 id="resources">Resources</h2>

<p>You will find the full source code, design files and additional description and advice at <a href="https://github.com/martinholub/mkzh-charioteer">the project’s repository on GitHub</a></p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://www.teil3.ch/index.html">Teil3 - 3D Printers</a></li>
  <li><a href="https://www.thethingsnetwork.org/docs/devices/uno/">The Things Network Uno</a></li>
  <li><a href="https://www.thethingsnetwork.org/docs/">TTN Documentation</a></li>
  <li><a href="https://www.thethingsnetwork.org/community/zurich/">Zurich TTN Community</a></li>
</ul>

  </article>

  
<!---
Call Fontawesome in the head section or in the location where you place the share bar
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
--->
<hr>
<br/>
<div class="share-box center" style="width: 60%; margin: 0px auto;">
<h2 class="center">Share this:</h2>
<br/>

<a class="f" href="https://www.facebook.com/sharer/sharer.php?u=http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-facebook-official fa"></i><span> facebook</span></a>

<a class="t" href="https://twitter.com/intent/tweet?text=CharIoTeer, Smart Last-Mile Delivery Project @MakeZurich&url=http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-twitter fa"></i><span> twitter</span></a>
<!---
<a class="g" href="https://plus.google.com/share?url=http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-google-plus fa"></i><span> google</span></a>

<a class="r" href="http://www.reddit.com/submit?url=http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-reddit fa"></i><span> reddit</span></a>
--->
<a class="l" href="https://www.linkedin.com/shareArticle?mini=true&url=http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html&title=CharIoTeer, Smart Last-Mile Delivery Project @MakeZurich&summary=&source=martinholub" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" ><i class="fa fa-linkedin fa"></i><span> linkedin</span></a>

<a class="e" href="mailto:?subject=CharIoTeer, Smart Last-Mile Delivery Project @MakeZurich&amp;body=Check out this site http://www.martinholub.com//eth/code/2018/08/05/MakeZurich.html"><i class="fa fa-envelope fa"></i><span> email</span></a>
</div>
<br/>
<hr>


  

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'martinholub'; // required: replace example with your forum shortname
        /*var disqus_developer = 1; // Comment out when the site is live */
        var disqus_identifier = "/eth/code/2018/08/05/MakeZurich.html";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




</div>

      </div>
    </div>

<!--
    <footer class="site-footer">

  <div class="wrapper">
  	<p>This site was built using <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and is hosted on <a href="https://github.com" target="_blank">Github</a>.</p>
  </div>
</footer>

-->
  <script id="dsq-count-scr" src="//martinholub.disqus.com/count.js" async></script>
  <script src="/css/lightbox.js"></script>

  </body>

</html>
